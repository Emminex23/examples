# sandbox.yaml
# Creates a Signadot sandbox that forks the HotROD location service
# with an isolated Dolt database branch.
#
# Usage:
#   signadot sandbox apply -f sandbox.yaml --set cluster=<YOUR_CLUSTER>
#
# The @{cluster} template variable is resolved at apply time via --set.

name: dolt-sandbox-demo
spec:
  cluster: "@{cluster}"
  description: "Location service with isolated Dolt database branch"

  # Request a Dolt branch resource.
  # The dolt-branch plugin runs its 'create' workflow before the fork starts.
  # It creates a new branch and exposes connection details as outputs.
  resources:
    - name: doltdb
      plugin: dolt-branch

  # Fork the location Deployment in the hotrod namespace.
  # The fork is a copy of the baseline pod spec with customized env vars.
  forks:
    - forkOf:
        kind: Deployment
        namespace: hotrod
        name: location
      customizations:
        env:
          # Override the primary connection address used by the HotROD app.
          # The baseline value (mysql.hotrod:3306) points at the original MySQL.
          # We redirect it to Dolt so the fork uses the version-controlled DB.
          - name: MYSQL_ADDR
            container: hotrod
            value: "dolt-db.hotrod.svc:3306"
          # Set the database name the app connects to.
          # The HotROD app reads MYSQL_DBNAME (not MYSQL_DATABASE).
          # The resource plugin outputs "location" (the base database name).
          # The plugin also sets this branch as Dolt's default, so the app
          # connects to "location" and Dolt serves the sandbox branch.
          - name: MYSQL_DBNAME
            container: hotrod
            valueFrom:
              resource:
                name: doltdb
                outputKey: createbranch.db-name
          # Pull the password from the same Secret the Dolt server uses.
          - name: MYSQL_PASS
            container: hotrod
            valueFrom:
              secret:
                name: dolt-credentials
                key: password

  # Create a default route group so the sandbox is accessible via
  # the Signadot preview URL or routed requests.
  defaultRouteGroup:
    endpoints:
      - name: location-api
        target: "http://location.hotrod.svc:8081"