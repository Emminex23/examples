# dolt-branch-plugin.yaml
# Signadot Resource Plugin that creates and deletes Dolt database branches.
#
# Usage:
#   signadot resourceplugin apply -f dolt-branch-plugin.yaml
#
# Prerequisites:
#   - The 'dolt-credentials' Secret must exist in the 'hotrod' namespace.
#   - The Dolt server must be running and accessible at dolt-db.hotrod.svc:3306.
#
# Note: Resource Plugins cannot be updated. To make changes, delete the plugin
# first (only possible when no sandboxes reference it), then re-apply.

name: dolt-branch
spec:
  description: Creates and deletes Dolt database branches for sandbox isolation

  runner:
    # debian:bookworm-slim provides apt-get for installing mysql-client at runtime.
    # Alternatives like bitnami/kubectl lack package management capabilities.
    image: debian:bookworm-slim

    # Run in the hotrod namespace so Dolt is reachable via Kubernetes DNS.
    namespace: hotrod

    # Inject Dolt connection details into the runner container.
    # The secretKeyRef fields pull credentials from the dolt-credentials Secret.
    podTemplateOverlay: |
      spec:
        containers:
          - name: main
            env:
              - name: DOLT_HOST
                value: "dolt-db.hotrod.svc"
              - name: DOLT_PORT
                value: "3306"
              - name: DOLT_USER
                valueFrom:
                  secretKeyRef:
                    name: dolt-credentials
                    key: username
              - name: DOLT_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: dolt-credentials
                    key: password
              - name: DOLT_DATABASE
                value: "location"

  # ---------- CREATE WORKFLOW ----------
  # Runs when a sandbox referencing this plugin is created.
  # Completes before any sandboxed workloads start.
  create:
    - name: createbranch
      script: |
        #!/bin/bash
        set -e

        # Install MySQL client (required for connecting to Dolt via SQL)
        apt-get update -qq && apt-get install -y -qq default-mysql-client > /dev/null 2>&1

        # Sanitize sandbox name: remove hyphens to produce a valid Dolt branch name.
        # Signadot sandbox names may contain hyphens (e.g., "fix-728"), but
        # keeping branch names alphanumeric avoids parsing issues in Dolt.
        # SIGNADOT_SANDBOX_NAME is automatically injected by the Signadot Operator.
        SAFE_NAME=$(echo "${SIGNADOT_SANDBOX_NAME}" | tr -d '-')
        BRANCH_NAME="sandbox${SAFE_NAME}"

        # Create a new branch from 'main' using DOLT_BRANCH().
        # Unlike DOLT_CHECKOUT('-b', ...), DOLT_BRANCH() creates the branch
        # without switching the current session to it. This is safer in a
        # multi-session server environment where other clients are connected.
        # Reference: https://docs.dolthub.com/sql-reference/version-control/dolt-sql-procedures
        mysql -h "${DOLT_HOST}" -P "${DOLT_PORT}" \
          -u "${DOLT_USER}" -p"${DOLT_PASSWORD}" "${DOLT_DATABASE}" \
          -e "CALL DOLT_BRANCH('${BRANCH_NAME}', 'main');"

        echo "Created Dolt branch: ${BRANCH_NAME}"

        # Set the sandbox branch as the default for the 'location' database.
        # All new connections to 'location' will now read from this branch.
        # This avoids the need to pass 'location/branchname' as the database
        # name, which breaks Go MySQL driver v1.7.1's DSN parser.
        mysql -h "${DOLT_HOST}" -P "${DOLT_PORT}" \
          -u "${DOLT_USER}" -p"${DOLT_PASSWORD}" \
          -e "SET @@GLOBAL.${DOLT_DATABASE}_default_branch = '${BRANCH_NAME}';"

        echo "Set default branch to: ${BRANCH_NAME}"

        # Write outputs to files. The Signadot Operator reads these paths
        # and makes the values available to sandbox workloads.
        #
        # db-name is "location" (not "location/branchname") because the app
        # connects to the base database name and Dolt serves the default branch.
        mkdir -p /outputs
        echo -n "${BRANCH_NAME}" > /outputs/branch-name
        echo -n "${DOLT_DATABASE}" > /outputs/db-name
        echo -n "${DOLT_HOST}" > /outputs/db-host
        echo -n "${DOLT_PORT}" > /outputs/db-port

      outputs:
        - name: branch-name
          valueFromPath: /outputs/branch-name
        - name: db-name
          valueFromPath: /outputs/db-name
        - name: db-host
          valueFromPath: /outputs/db-host
        - name: db-port
          valueFromPath: /outputs/db-port

  # ---------- DELETE WORKFLOW ----------
  # Runs when the sandbox is deleted.
  # Executes after sandboxed workloads have terminated.
  delete:
    - name: deletebranch
      inputs:
        # Read the branch name from the create step's output.
        # valueFromStep references a specific output from a named step.
        - name: branch-name
          valueFromStep:
            name: createbranch
            output: branch-name
          as:
            env: BRANCH_NAME
      script: |
        #!/bin/bash
        set -e

        apt-get update -qq && apt-get install -y -qq default-mysql-client > /dev/null 2>&1

        # Reset the default branch to 'main' before deleting the sandbox branch.
        mysql -h "${DOLT_HOST}" -P "${DOLT_PORT}" \
          -u "${DOLT_USER}" -p"${DOLT_PASSWORD}" \
          -e "SET @@GLOBAL.${DOLT_DATABASE}_default_branch = 'main';"

        echo "Reset default branch to: main"

        # Delete the sandbox branch using DOLT_BRANCH('-D', ...).
        # The '-D' flag performs a force delete. This is necessary because
        # the sandbox branch may contain commits that are not merged into
        # 'main' (e.g., data fixes made by the agent). The standard '-d'
        # flag would refuse to delete an unmerged branch.
        # Reference: https://docs.dolthub.com/sql-reference/version-control/dolt-sql-procedures
        mysql -h "${DOLT_HOST}" -P "${DOLT_PORT}" \
          -u "${DOLT_USER}" -p"${DOLT_PASSWORD}" "${DOLT_DATABASE}" \
          -e "CALL DOLT_BRANCH('-D', '${BRANCH_NAME}');"

        echo "Deleted Dolt branch: ${BRANCH_NAME}"